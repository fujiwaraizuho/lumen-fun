box: dala00/laravel
services:
  - id: mysql
    tag: 5.7
    env:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_USER: admin
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: lumen_fun_test

build:
  steps:
    - script:
        name: Install dependencies
        code: |
          composer install

    - script:
        name: Fill mysql env.
        code: |-
          sudo cp .env.example .env.testing
          sudo sed -i -e "s/DB_HOST=127.0.0.1/DB_HOST=$MYSQL_PORT_3306_TCP_ADDR/g" .env.testing
          sudo sed -i -e "s/DB_USERNAME=homestead/DB_USERNAME=admin/g" .env.testing
          sudo sed -i -e "s/DB_PASSWORD=secret/DB_PASSWORD=password/g" .env.testing

    - script:
        name: Check PHP
        code: |-
          mysql -uroot -p < SHOW VARIABLES like 'socket'
          php -i | grep socket

    - script:
        name: Run phpunit
        code: |-
          vendor/bin/phpunit
